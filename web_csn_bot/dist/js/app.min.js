const div_message = document.querySelector('#message')
const formatDate = (date) => date.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" });
const div_msger = document.querySelector('.msger')
window.addEventListener("load", () => {
    const req = new XMLHttpRequest();
    req.addEventListener("load", () => {
        JSON.parse(req.responseText).reverse().forEach(({ name, content, created_at, avatar_url, photo }) => {
            created_at = mon_day_hou_min(created_at)
            div_message.append(createDiv(name, content, created_at, avatar_url, photo));
            window.scrollTo(0, document.body.scrollHeight);
        });
    });
    req.open("GET", "get_data.php", true);
    req.send();
});

// Pusher.logToConsole = true;
var pusher = new Pusher('53d916e1cb5d74805c3a', {
    cluster: 'mt1'
});
const channel = pusher.subscribe("my-channel");
channel.bind("chat_casino", ({ name, message, hour_minutes, avatar_url, message_img }) => {
    // console.log(name, message, hour_minutes, avatar_url, message_img)
    hour_minutes = mon_day_hou_min(hour_minutes)
    div_message.append(createDiv(name, message, hour_minutes, avatar_url, message_img));
    window.scrollTo(0, document.body.scrollHeight);
});

const createDiv = (name, content, created_at, avatar, message_img) => {
    const div_left = document.createElement('div')
    div_left.classList.add('msg', 'left-msg')
    const div_img = document.createElement('div')
    div_img.classList.add('msg-img')
    const img_avt = document.createElement('img')
    img_avt.src = 'dist/media/img/avt_default.jpg'
    if (avatar != null) {
        img_avt.src = avatar
    }
    img_avt.style.width = '100%'
    img_avt.style.borderRadius = '35px'
    div_img.appendChild(img_avt)

    const msg_bubble = document.createElement('div')
    msg_bubble.classList.add('msg-bubble')
    const msg_info = document.createElement('div')
    msg_info.classList.add('msg-info')
    const msg_info_name = document.createElement('div')
    msg_info_name.classList.add('msg-info-name')
    msg_info_name.textContent = name
    const msg_info_time = document.createElement('i')
    msg_info_time.classList.add('msg-info-time')
    msg_info_time.textContent = created_at

    const msg_text = document.createElement('div')
    msg_text.classList.add('msg-text')
    msg_text.textContent = content

    if (message_img != null) {
        const div_text = document.createElement('div')
        div_text.textContent = content
        msg_text.textContent = ''
        const mess_photo = document.createElement('img')
        mess_photo.src = message_img
        mess_photo.style.width = '250px'
        msg_text.append(mess_photo, div_text)

    }

    msg_info.append(msg_info_name, msg_info_time)
    msg_bubble.append(msg_info, msg_text)

    div_left.append(div_img, msg_bubble)
    return div_left
};

const mon_day_hou_min = (date) => {
    const timeString = date;
    const dateObj = new Date(timeString);
    let month = dateObj.getMonth() + 1;
    if (month < 10) {
        month = '0' + month
    }
    let day = dateObj.getDate();
    if (day < 10) {
        day = '0' + day
    }
    let hours = dateObj.getHours();
    if (hours < 10) {
        hours = '0' + hours
    }
    let minutes = dateObj.getMinutes();
    if (minutes < 10) {
        minutes = '0' + minutes
    }
    let formattedTime = `${month}-${day} ${hours}:${minutes}`;
    return formattedTime
}